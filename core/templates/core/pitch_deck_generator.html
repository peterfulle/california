{% extends 'base.html' %}
{% load static %}

{% block title %}AI Pitch Deck Generator - {{ startup.company_name }}{% endblock %}

{% block extra_css %}
<style>
    .slide-preview {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        padding: 3rem;
        min-height: 400px;
    }
    
    .generate-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .slide-nav-item {
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .slide-nav-item.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .slide-nav-item:hover {
        background: #f3f4f6;
    }
    
    .slide-nav-item.active:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900 mb-2">
                        <i class="fas fa-magic text-indigo-600 mr-3"></i>
                        AI Pitch Deck Generator
                    </h1>
                    <p class="text-lg text-gray-600">
                        {{ startup.company_name }}
                    </p>
                </div>
                <a href="{% url 'core:startup_profile' startup.id %}" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Volver
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Slide Preview -->
            <div class="lg:col-span-2">
                <div class="slide-preview" id="slideContent">
                    <div class="text-center py-16">
                        <p class="text-gray-500">Selecciona un slide o genera contenido</p>
                    </div>
                </div>
                
                <div class="flex justify-between mt-6">
                    <button onclick="app.previousSlide()" class="px-6 py-3 bg-white border-2 border-gray-300 rounded-lg font-medium">
                        <i class="fas fa-arrow-left mr-2"></i> Anterior
                    </button>
                    <button onclick="app.nextSlide()" class="px-6 py-3 bg-white border-2 border-gray-300 rounded-lg font-medium">
                        Siguiente <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl p-6 shadow-lg">
                    <h3 class="text-xl font-bold mb-4">Slides</h3>
                    
                    <div id="slideNav" class="space-y-2 mb-6">
                        <!-- Se llenar√° con JS -->
                    </div>
                    
                    <button onclick="app.generateSlide()" class="generate-btn w-full py-3 px-6 text-white rounded-lg font-semibold mb-4">
                        <i class="fas fa-magic mr-2"></i>
                        Generar Este Slide
                    </button>
                    
                    <textarea 
                        id="customInstructions"
                        rows="4"
                        class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg mb-4"
                        placeholder="Instrucciones personalizadas..."></textarea>
                    
                    <div class="text-sm text-gray-600">
                        Progreso: <span id="progress">0/11</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const app = {
    currentSlide: 0,
    slides: [
        { type: 'company_purpose', title: 'Company Purpose', content: null },
        { type: 'problem', title: 'Problem', content: null },
        { type: 'solution', title: 'Solution', content: null },
        { type: 'market_opportunity', title: 'Market', content: null },
        { type: 'product', title: 'Product', content: null },
        { type: 'business_model', title: 'Business Model', content: null },
        { type: 'traction', title: 'Traction', content: null },
        { type: 'competition', title: 'Competition', content: null },
        { type: 'team', title: 'Team', content: null },
        { type: 'financials', title: 'Financials', content: null },
        { type: 'ask', title: 'The Ask', content: null }
    ],
    
    init() {
        this.loadFromStorage();
        this.renderNav();
        this.renderSlide();
    },
    
    loadFromStorage() {
        const saved = localStorage.getItem('pitch_deck_{{ startup.id }}');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                data.forEach((saved, i) => {
                    if (this.slides[i] && saved.content) {
                        this.slides[i].content = saved.content;
                    }
                });
                console.log('‚úÖ Loaded from storage');
            } catch (e) {
                console.error('Error loading:', e);
            }
        }
    },
    
    saveToStorage() {
        localStorage.setItem('pitch_deck_{{ startup.id }}', JSON.stringify(this.slides));
        console.log('üíæ Saved');
    },
    
    renderNav() {
        const nav = document.getElementById('slideNav');
        nav.innerHTML = this.slides.map((slide, i) => `
            <div onclick="app.goToSlide(${i})" 
                 class="slide-nav-item px-4 py-2 rounded-lg text-sm font-medium ${i === this.currentSlide ? 'active' : 'bg-gray-50'}">
                ${slide.title}
                ${slide.content ? '<span class="ml-2 text-green-500">‚úì</span>' : ''}
            </div>
        `).join('');
        
        const completed = this.slides.filter(s => s.content).length;
        document.getElementById('progress').textContent = `${completed}/11`;
    },
    
    renderSlide() {
        const slide = this.slides[this.currentSlide];
        const content = document.getElementById('slideContent');
        
        console.log('üéØ Rendering slide:', this.currentSlide, slide.type);
        console.log('üì¶ Slide content:', slide.content);
        
        if (!slide.content) {
            console.log('‚ö†Ô∏è No content for this slide');
            content.innerHTML = `
                <div class="text-center py-16">
                    <i class="fas fa-file-powerpoint text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Este slide no ha sido generado</h3>
                    <p class="text-gray-500">Haz clic en "Generar Este Slide"</p>
                </div>
            `;
            return;
        }
        
        console.log('‚úÖ Rendering content for type:', slide.type);
        
        // Renderizar seg√∫n el tipo
        if (slide.type === 'company_purpose') {
            content.innerHTML = `
                <div class="text-center mb-8">
                    <h2 class="text-4xl font-bold text-gray-900 mb-4">${slide.content.title || 'Company Purpose'}</h2>
                    <p class="text-xl text-gray-700 leading-relaxed">${slide.content.mission || ''}</p>
                </div>
                <div class="border-t-2 border-gray-200 pt-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Vision</h3>
                    <p class="text-gray-700">${slide.content.vision || ''}</p>
                </div>
            `;
        } else if (slide.type === 'problem') {
            content.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-900 mb-6">${slide.content.title || 'Problem'}</h2>
                <div class="bg-gray-50 border-l-4 border-gray-900 p-6 mb-6">
                    <p class="text-lg text-gray-800 leading-relaxed">${slide.content.problem_statement || ''}</p>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Pain Points</h3>
                <div class="space-y-3">
                    ${(slide.content.pain_points || []).map(point => `
                        <div class="flex items-start">
                            <span class="text-gray-900 font-bold mr-3">‚Ä¢</span>
                            <p class="text-gray-700">${point}</p>
                        </div>
                    `).join('')}
                </div>
                ${slide.content.market_impact ? `
                    <div class="mt-6 bg-white border-2 border-gray-200 p-4 rounded-lg">
                        <p class="text-sm font-semibold text-gray-900 mb-2">Market Impact</p>
                        <p class="text-gray-700">${slide.content.market_impact}</p>
                    </div>
                ` : ''}
            `;
        } else if (slide.type === 'solution') {
            content.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-900 mb-6">${slide.content.title || 'Solution'}</h2>
                <div class="bg-gray-50 p-6 rounded-lg mb-6">
                    <p class="text-lg text-gray-800 leading-relaxed">${slide.content.solution_overview || ''}</p>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Key Features</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${(slide.content.key_features || []).map(feature => `
                        <div class="bg-white border border-gray-200 p-4 rounded-lg">
                            <p class="text-gray-800">${feature}</p>
                        </div>
                    `).join('')}
                </div>
                ${slide.content.unique_value_proposition ? `
                    <div class="mt-6 bg-gray-900 text-white p-6 rounded-lg">
                        <p class="text-sm font-semibold mb-2">Unique Value Proposition</p>
                        <p class="text-lg">${slide.content.unique_value_proposition}</p>
                    </div>
                ` : ''}
            `;
        } else if (slide.type === 'market_opportunity') {
            content.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-900 mb-6">${slide.content.title || 'Market Opportunity'}</h2>
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-gray-50 p-6 rounded-lg text-center border-2 border-gray-200">
                        <div class="text-sm font-bold text-gray-900 mb-2">TAM</div>
                        <div class="text-2xl font-bold text-gray-800">${slide.content.tam || 'N/A'}</div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-lg text-center border-2 border-gray-200">
                        <div class="text-sm font-bold text-gray-900 mb-2">SAM</div>
                        <div class="text-2xl font-bold text-gray-800">${slide.content.sam || 'N/A'}</div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-lg text-center border-2 border-gray-200">
                        <div class="text-sm font-bold text-gray-900 mb-2">SOM</div>
                        <div class="text-2xl font-bold text-gray-800">${slide.content.som || 'N/A'}</div>
                    </div>
                </div>
                ${slide.content.growth_rate ? `
                    <div class="bg-gray-50 border-l-4 border-gray-900 p-4 mb-4">
                        <p class="font-semibold text-gray-900 mb-2">Growth Rate</p>
                        <p class="text-gray-800">${slide.content.growth_rate}</p>
                    </div>
                ` : ''}
                ${slide.content.insight ? `
                    <div class="bg-white border-2 border-gray-200 p-4 rounded-lg">
                        <p class="text-gray-700">${slide.content.insight}</p>
                    </div>
                ` : ''}
            `;
        } else if (slide.type === 'product') {
            content.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-900 mb-6">${slide.content.title || 'Product'}</h2>
                <div class="bg-gray-50 p-6 rounded-lg mb-6">
                    <p class="text-lg text-gray-800">${slide.content.product_description || ''}</p>
                </div>
                ${slide.content.key_capabilities ? `
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Key Capabilities</h3>
                    <div class="space-y-3 mb-6">
                        ${(slide.content.key_capabilities || []).map(cap => `
                            <div class="bg-white border-l-4 border-gray-900 p-4">
                                <p class="text-gray-800">${cap}</p>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                ${slide.content.technology_stack ? `
                    <div class="bg-gray-900 text-white p-6 rounded-lg">
                        <p class="text-sm font-semibold mb-2">Technology Stack</p>
                        <p>${slide.content.technology_stack}</p>
                    </div>
                ` : ''}
            `;
        } else if (slide.type === 'business_model') {
            content.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-900 mb-6">${slide.content.title || 'Business Model'}</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    ${slide.content.revenue_streams ? `
                        <div class="bg-gray-50 p-6 rounded-lg border-2 border-gray-200">
                            <h3 class="text-lg font-bold text-gray-900 mb-3">Revenue Streams</h3>
                            <div class="space-y-2">
                                ${(slide.content.revenue_streams || []).map(stream => `
                                    <p class="text-gray-700">‚Ä¢ ${stream}</p>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${slide.content.pricing_strategy ? `
                        <div class="bg-gray-50 p-6 rounded-lg border-2 border-gray-200">
                            <h3 class="text-lg font-bold text-gray-900 mb-3">Pricing Strategy</h3>
                            <p class="text-gray-700">${slide.content.pricing_strategy}</p>
                        </div>
                    ` : ''}
                </div>
                ${slide.content.unit_economics ? `
                    <div class="bg-white border-2 border-gray-900 p-6 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-900 mb-3">Unit Economics</h3>
                        <p class="text-gray-700">${slide.content.unit_economics}</p>
                    </div>
                ` : ''}
            `;
        } else if (slide.type === 'traction') {
            content.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-900 mb-6">${slide.content.title || 'Traction'}</h2>
                ${slide.content.key_metrics ? `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        ${(slide.content.key_metrics || []).map(metric => `
                            <div class="bg-gray-50 p-4 rounded-lg text-center border-2 border-gray-200">
                                <p class="text-sm text-gray-600 mb-1">${metric.label || ''}</p>
                                <p class="text-2xl font-bold text-gray-900">${metric.value || ''}</p>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                ${slide.content.milestones ? `
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Milestones</h3>
                    <div class="space-y-3">
                        ${(slide.content.milestones || []).map(milestone => `
                            <div class="bg-white border-l-4 border-gray-900 p-4">
                                <p class="text-gray-800">${milestone}</p>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
        } else if (slide.type === 'competition') {
            content.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-900 mb-6">${slide.content.title || 'Competition'}</h2>
                ${slide.content.competitive_advantage ? `
                    <div class="bg-gray-900 text-white p-6 rounded-lg mb-6">
                        <h3 class="text-lg font-semibold mb-3">Competitive Advantage</h3>
                        <p class="text-lg">${slide.content.competitive_advantage}</p>
                    </div>
                ` : ''}
                ${slide.content.competitors ? `
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Key Competitors</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${(slide.content.competitors || []).map(comp => `
                            <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg">
                                <p class="font-semibold text-gray-900 mb-2">${comp.name || ''}</p>
                                <p class="text-sm text-gray-700">${comp.weakness || ''}</p>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
        } else if (slide.type === 'team') {
            content.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-900 mb-6">${slide.content.title || 'Team'}</h2>
                ${slide.content.team_members ? `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${(slide.content.team_members || []).map(member => `
                            <div class="bg-gray-50 p-6 rounded-lg border-2 border-gray-200">
                                <h3 class="text-lg font-bold text-gray-900 mb-1">${member.name || ''}</h3>
                                <p class="text-sm font-semibold text-gray-600 mb-3">${member.role || ''}</p>
                                <p class="text-gray-700 text-sm">${member.background || ''}</p>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
        } else if (slide.type === 'financials') {
            content.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-900 mb-6">${slide.content.title || 'Financials'}</h2>
                ${slide.content.projections ? `
                    <div class="bg-gray-50 p-6 rounded-lg mb-6 border-2 border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Projections</h3>
                        <div class="space-y-3">
                            ${(slide.content.projections || []).map(proj => `
                                <div class="flex justify-between items-center bg-white p-3 rounded">
                                    <span class="font-semibold text-gray-900">${proj.year || ''}</span>
                                    <span class="text-lg font-bold text-gray-900">${proj.revenue || ''}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                ${slide.content.use_of_funds ? `
                    <div class="bg-white border-2 border-gray-900 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Use of Funds</h3>
                        <div class="space-y-2">
                            ${(slide.content.use_of_funds || []).map(item => `
                                <p class="text-gray-700">‚Ä¢ ${item}</p>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        } else if (slide.type === 'ask') {
            content.innerHTML = `
                <div class="text-center">
                    <h2 class="text-4xl font-bold text-gray-900 mb-8">${slide.content.title || 'The Ask'}</h2>
                    ${slide.content.funding_amount ? `
                        <div class="bg-gray-900 text-white p-8 rounded-lg mb-6">
                            <p class="text-sm font-semibold mb-2">Seeking</p>
                            <p class="text-5xl font-bold">${slide.content.funding_amount}</p>
                        </div>
                    ` : ''}
                    ${slide.content.purpose ? `
                        <div class="bg-gray-50 p-6 rounded-lg mb-6 border-2 border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Purpose</h3>
                            <p class="text-gray-700">${slide.content.purpose}</p>
                        </div>
                    ` : ''}
                    ${slide.content.timeline ? `
                        <div class="bg-white border-2 border-gray-200 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Timeline</h3>
                            <p class="text-gray-700">${slide.content.timeline}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        } else {
            // Default view - mostrar JSON
            content.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">${slide.title}</h2>
                <pre class="bg-gray-100 p-4 rounded text-sm overflow-auto">${JSON.stringify(slide.content, null, 2)}</pre>
            `;
        }
        
        this.renderNav();
    },
    
    goToSlide(index) {
        this.currentSlide = index;
        this.renderSlide();
    },
    
    nextSlide() {
        if (this.currentSlide < this.slides.length - 1) {
            this.currentSlide++;
            this.renderSlide();
        }
    },
    
    previousSlide() {
        if (this.currentSlide > 0) {
            this.currentSlide--;
            this.renderSlide();
        }
    },
    
    async generateSlide() {
        const slide = this.slides[this.currentSlide];
        const instructions = document.getElementById('customInstructions').value;
        
        const content = document.getElementById('slideContent');
        content.innerHTML = '<div class="text-center py-16"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div><p class="mt-4 text-gray-600">Generando...</p></div>';
        
        try {
            const response = await fetch('{% url "core:generate_pitch_deck_slide" startup.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    slide_type: slide.type,
                    custom_instructions: instructions
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                slide.content = data.content;
                this.saveToStorage();
                this.renderSlide();
            } else {
                alert('Error: ' + data.error);
                this.renderSlide();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al generar el slide');
            this.renderSlide();
        }
    }
};

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', () => app.init());
</script>
{% endblock %}
